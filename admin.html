<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Dashboard | HRZ</title>
    <link href="https://fonts.googleapis.com/css2?family=Outfit:wght@300;400;600;800&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="styles.css">

    <!-- Auth Check -->
    <script>
        const user = JSON.parse(localStorage.getItem('currentUser'));
        if (!user || user.role !== 'admin') {
            window.location.href = 'login.html';
        }
    </script>
</head>

<body>
    <nav class="navbar glass">
        <a href="index.html" class="logo"
            style="text-decoration: none; color: white; font-weight: 800; font-size: 1.5rem;">HRZ Admin</a>
        <div class="nav-links">
            <a href="#" onclick="logout()" style="color: white; text-decoration: none;">Logout</a>
        </div>
    </nav>

    <main style="padding-top: 100px; padding-bottom: 50px;">
        <div class="container">
            <div class="admin-header">
                <h1>Dashboard</h1>
                <div class="admin-actions">
                    <button id="sync-status" onclick="initializeSync()"
                        style="padding: 0.8rem 1.5rem; background: #333; color: #aaa; border: 1px solid #444; border-radius: 50px; cursor: pointer; margin-right: 1rem; transition: all 0.3s;">
                        ðŸ”— Link Database
                    </button>
                    <button onclick="toggleAddProductForm()" class="btn-primary"
                        style="padding: 0.8rem 2rem; font-size: 1rem;">+ Add New Drop</button>
                </div>
            </div>

            <!-- Add Product Form (Hidden by default) -->
            <div id="add-product-form" class="glass"
                style="display: none; padding: 3rem; border-radius: 24px; margin-bottom: 3rem; position: relative;">
                <button onclick="toggleAddProductForm()"
                    style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer;">&times;</button>
                <h2 style="margin-bottom: 2rem; font-size: 2rem; text-align: center;">New Drop Details</h2>

                <form onsubmit="handleAddNewProduct(event)"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

                    <!-- Left Column: Details -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Product Name</label>
                            <input type="text" id="new-name" class="glass-input" required
                                placeholder="Ex: Shadow Strike Hoodie">
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Price (dh)</label>
                            <input type="number" id="new-price" class="glass-input" required placeholder="250"
                                step="0.01">
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Category</label>
                            <div style="display: flex; gap: 0.5rem; align-items: flex-end;">
                                <select id="new-category" class="glass-input" required
                                    style="cursor: pointer; flex: 1;">
                                    <option value="Anime">Anime</option>
                                </select>
                                <button type="button" onclick="removeCategory()"
                                    style="padding: 1rem; background: rgba(239, 68, 68, 0.2); border: 1px solid rgba(239, 68, 68, 0.4); border-radius: 12px; color: #ef4444; cursor: pointer; transition: all 0.3s; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.8rem; font-weight: bold;"
                                    onmouseover="this.style.background='rgba(239, 68, 68, 0.3)'"
                                    onmouseout="this.style.background='rgba(239, 68, 68, 0.2)'"
                                    title="Remove category">âˆ’</button>
                                <button type="button" onclick="addNewCategory()"
                                    style="padding: 1rem; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; color: var(--accent-secondary); cursor: pointer; transition: all 0.3s; width: 50px; height: 50px; display: flex; align-items: center; justify-content: center; font-size: 1.5rem; font-weight: bold;"
                                    onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'"
                                    onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'">+</button>
                            </div>
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Description</label>
                            <textarea id="new-desc" class="glass-input" rows="5" required
                                placeholder="Tell the story of this piece..."></textarea>
                        </div>

                        <!-- Colors Section -->
                        <div class="form-group">
                            <label
                                style="color: #a3a3a3; font-size: 0.9rem; margin-bottom: 0.8rem; display: block;">Available
                                Colors</label>

                            <!-- Predefined Colors -->
                            <div style="display: flex; flex-wrap: wrap; gap: 0.8rem; margin-bottom: 1rem;">
                                <div class="color-option" data-color="#000000" onclick="toggleColor('#000000', 'Black')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #000000; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Black</span>
                                </div>

                                <div class="color-option" data-color="#FFFFFF" onclick="toggleColor('#FFFFFF', 'White')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #FFFFFF; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="black"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">White</span>
                                </div>

                                <div class="color-option" data-color="#6B7280" onclick="toggleColor('#6B7280', 'Gray')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #6B7280; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Gray</span>
                                </div>

                                <div class="color-option" data-color="#1E3A8A" onclick="toggleColor('#1E3A8A', 'Navy')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #1E3A8A; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Navy</span>
                                </div>

                                <div class="color-option" data-color="#DC2626" onclick="toggleColor('#DC2626', 'Red')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #DC2626; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Red</span>
                                </div>

                                <div class="color-option" data-color="#059669" onclick="toggleColor('#059669', 'Green')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #059669; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Green</span>
                                </div>

                                <div class="color-option" data-color="#7C3AED"
                                    onclick="toggleColor('#7C3AED', 'Purple')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #7C3AED; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Purple</span>
                                </div>

                                <div class="color-option" data-color="#EA580C"
                                    onclick="toggleColor('#EA580C', 'Orange')"
                                    style="position: relative; cursor: pointer; transition: all 0.3s;">
                                    <div
                                        style="width: 45px; height: 45px; background: #EA580C; border-radius: 10px; border: 2px solid rgba(255,255,255,0.2); transition: all 0.3s;">
                                    </div>
                                    <div class="color-check"
                                        style="position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); opacity: 0; transition: opacity 0.3s;">
                                        <svg width="20" height="20" viewBox="0 0 24 24" fill="none" stroke="white"
                                            stroke-width="3">
                                            <polyline points="20 6 9 17 4 12"></polyline>
                                        </svg>
                                    </div>
                                    <span
                                        style="font-size: 0.7rem; color: #888; text-align: center; display: block; margin-top: 0.3rem;">Orange</span>
                                </div>
                            </div>

                            <!-- Custom Color Picker -->
                            <div style="display: flex; gap: 0.8rem; align-items: center;">
                                <div style="position: relative;">
                                    <input type="color" id="custom-color-picker"
                                        style="width: 45px; height: 45px; border: 2px solid rgba(139, 92, 246, 0.4); border-radius: 10px; background: transparent; cursor: pointer;">
                                </div>
                                <input type="text" id="custom-color-name" class="glass-input"
                                    placeholder="Color name (e.g., Burgundy)"
                                    style="flex: 1; padding: 0.8rem; font-size: 0.9rem;">
                                <button type="button" onclick="addCustomColor()"
                                    style="padding: 0.8rem 1.5rem; background: rgba(139, 92, 246, 0.2); border: 1px solid rgba(139, 92, 246, 0.4); border-radius: 12px; color: var(--accent-secondary); cursor: pointer; transition: all 0.3s; font-weight: 600; white-space: nowrap;"
                                    onmouseover="this.style.background='rgba(139, 92, 246, 0.3)'"
                                    onmouseout="this.style.background='rgba(139, 92, 246, 0.2)'">
                                    + Add Color
                                </button>
                            </div>

                            <!-- Selected Colors Display -->
                            <div id="selected-colors-display"
                                style="margin-top: 1rem; padding: 1rem; background: rgba(255,255,255,0.02); border: 1px solid rgba(255,255,255,0.05); border-radius: 12px; min-height: 60px; display: none;">
                                <div
                                    style="font-size: 0.8rem; color: #888; margin-bottom: 0.5rem; text-transform: uppercase; letter-spacing: 1px;">
                                    Selected Colors:</div>
                                <div id="selected-colors-list" style="display: flex; flex-wrap: wrap; gap: 0.5rem;">
                                </div>
                            </div>

                            <!-- Hidden input to store selected colors -->
                            <input type="hidden" id="product-colors" value="[]">
                        </div>
                    </div>

                    <!-- Right Column: Images -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <!-- Front Image Upload -->
                        <div class="form-group">
                            <label>Front View</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="new-img-front-file" accept="image/*"
                                    onchange="previewImage(this, 'preview-front')">
                                <div class="file-upload-placeholder" id="preview-front">
                                    <span style="font-size: 2rem;">ðŸ“·</span>
                                    <span>Click to Upload Front Image</span>
                                </div>
                            </div>
                        </div>

                        <!-- Back Image Upload -->
                        <div class="form-group">
                            <label>Back View (Hover)</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="new-img-back-file" accept="image/*"
                                    onchange="previewImage(this, 'preview-back')">
                                <div class="file-upload-placeholder" id="preview-back">
                                    <span style="font-size: 2rem;">ðŸ”„</span>
                                    <span>Click to Upload Back Image</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary"
                        style="grid-column: span 2; margin-top: 1rem; padding: 1rem; font-size: 1.1rem;">Launch Product
                        ðŸš€</button>
                </form>
            </div>

            <!-- Edit Product Form (Hidden by default) -->
            <div id="edit-product-form" class="glass"
                style="display: none; padding: 3rem; border-radius: 24px; margin-bottom: 3rem; position: relative;">
                <button onclick="toggleEditProductForm()"
                    style="position: absolute; top: 1.5rem; right: 1.5rem; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer;">&times;</button>
                <h2 style="margin-bottom: 2rem; font-size: 2rem; text-align: center;">Edit Product</h2>

                <form onsubmit="handleEditProduct(event)"
                    style="display: grid; grid-template-columns: 1fr 1fr; gap: 2rem;">

                    <input type="hidden" id="edit-id">

                    <!-- Left Column: Details -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Product Name</label>
                            <input type="text" id="edit-name" class="glass-input" required>
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Price (dh)</label>
                            <input type="number" id="edit-price" class="glass-input" required step="0.01">
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Category</label>
                            <select id="edit-category" class="glass-input" required style="cursor: pointer;">
                                <option value="Anime">Anime</option>
                            </select>
                        </div>
                        <div class="form-group">
                            <label style="color: #a3a3a3; font-size: 0.9rem;">Description</label>
                            <textarea id="edit-desc" class="glass-input" rows="5" required></textarea>
                        </div>
                    </div>

                    <!-- Right Column: Images (Optional update) -->
                    <div style="display: flex; flex-direction: column; gap: 1.5rem;">
                        <p style="font-size: 0.8rem; color: #666; margin-bottom: 0;">Leave images empty to keep current
                            ones.</p>

                        <!-- Front Image Upload -->
                        <div class="form-group">
                            <label>New Front View (Optional)</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="edit-img-front-file" accept="image/*"
                                    onchange="previewImage(this, 'edit-preview-front')">
                                <div class="file-upload-placeholder" id="edit-preview-front">
                                    <span style="font-size: 2rem;">ðŸ“·</span>
                                    <span>Click to Change Front Image</span>
                                </div>
                            </div>
                        </div>

                        <!-- Back Image Upload -->
                        <div class="form-group">
                            <label>New Back View (Optional)</label>
                            <div class="file-upload-wrapper">
                                <input type="file" id="edit-img-back-file" accept="image/*"
                                    onchange="previewImage(this, 'edit-preview-back')">
                                <div class="file-upload-placeholder" id="edit-preview-back">
                                    <span style="font-size: 2rem;">ðŸ”„</span>
                                    <span>Click to Change Back Image</span>
                                </div>
                            </div>
                        </div>
                    </div>

                    <button type="submit" class="btn-primary"
                        style="grid-column: span 2; margin-top: 1rem; padding: 1rem; font-size: 1.1rem; background: var(--accent-secondary); color: white;">Save
                        Changes</button>
                </form>
            </div>

            <!-- Professional Product List -->
            <div class="glass" style="padding: 2rem; border-radius: 24px;">
                <h3 style="margin-bottom: 2rem; font-size: 1.5rem; color: #a3a3a3; font-weight: 400;">Inventory</h3>

                <!-- Header Row -->
                <div
                    style="display: flex; padding: 0 1rem; margin-bottom: 1rem; color: #666; font-size: 0.8rem; text-transform: uppercase; letter-spacing: 1px;">
                    <span style="width: 60px; margin-right: 1.5rem;">Image</span>
                    <span style="flex-grow: 1;">Product Details</span>
                    <span>Actions</span>
                </div>

                <div id="admin-product-list" style="display: flex; flex-direction: column; gap: 0.5rem;">
                    <!-- Injected via JS -->
                </div>
            </div>
        </div>
    </main>

    <!-- Add Category Modal -->
    <div id="add-category-modal"
        style="display: none; position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.8); z-index: 3000; backdrop-filter: blur(5px); align-items: center; justify-content: center;">
        <div class="glass"
            style="background: #0a0a0a; border: 1px solid #333; padding: 2rem; border-radius: 16px; max-width: 400px; width: 90%; position: relative;">
            <button onclick="closeAddCategoryModal()"
                style="position: absolute; top: 1rem; right: 1rem; background: none; border: none; color: #666; font-size: 1.5rem; cursor: pointer;">&times;</button>
            <h2 style="margin-bottom: 1.5rem; font-size: 1.5rem;">Add New Category</h2>
            <input type="text" id="new-category-input" class="glass-input" placeholder="Enter category name..."
                style="margin-bottom: 1.5rem;">
            <div style="display: flex; gap: 1rem;">
                <button onclick="closeAddCategoryModal()"
                    style="flex: 1; padding: 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; color: white; cursor: pointer;">Cancel</button>
                <button onclick="confirmAddCategory()" class="btn-primary"
                    style="flex: 1; padding: 0.8rem; border: none; border-radius: 8px; cursor: pointer;">Add
                    Category</button>
            </div>
        </div>
    </div>

    <script src="script.js"></script>
    <script>
        // DIRECT OVERRIDE OF ADMIN LOGIC TO ENSURE IT WORKS
        // This runs locally on this page, bypassing any external script issues.

        function renderAdminProductsDirect() {
            console.log("Rendering Admin Products (Direct Mode)...");
            const listContainer = document.getElementById('admin-product-list');
            if (!listContainer) return;

            // Use the global variable from script.js (which combines Defaults + LocalStorage)
            let localProducts = (typeof products !== 'undefined') ? products : [];

            // Fallback if global is somehow missing
            if (localProducts.length === 0) {
                const raw = localStorage.getItem('products');
                if (raw) localProducts = JSON.parse(raw);
            }

            // Clearing/Empty State
            listContainer.innerHTML = '';
            if (localProducts.length === 0) {
                listContainer.innerHTML = `
                    <div style="text-align: center; padding: 3rem; color: #666;">
                        <p style="font-size: 1.2rem;">No products yet.</p>
                        <p>Click "+ Add Product" to drop your first item.</p>
                    </div>`;
                return;
            }

            // Render List
            listContainer.innerHTML = localProducts.map(product => `
                <div class="admin-product-item glass" style="display: flex; align-items: center; padding: 1rem; margin-bottom: 1rem; border-radius: 12px; transition: transform 0.2s; border: 1px solid rgba(255,255,255,0.05);">
                    <div style="width: 60px; height: 60px; border-radius: 8px; overflow: hidden; background: #1a1a1a; flex-shrink: 0; margin-right: 1.5rem;">
                        <img src="${product.image}" style="width: 100%; height: 100%; object-fit: cover;">
                    </div>
                    <div style="flex-grow: 1;">
                        <h4 style="margin: 0; font-size: 1rem; margin-bottom: 0.2rem;">${product.name}</h4>
                        <div style="display: flex; gap: 1rem; font-size: 0.85rem; color: #888;">
                            <span style="color: var(--accent-primary); font-weight: 600;">${Number(product.price).toFixed(2)}dh</span>
                            <span style="font-family: monospace; opacity: 0.5;">ID: ${product.id}</span>
                        </div>
                    </div>
                    <div style="display: flex; gap: 0.5rem;">
                        <!-- Using explicit onclick with the local function -->
                        <button class="btn-edit" onclick="openEditProductModal('${product.id}')" style="background: rgba(139, 92, 246, 0.1); color: var(--accent-secondary); border: 1px solid rgba(139, 92, 246, 0.2); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(139, 92, 246, 0.2)'" onmouseout="this.style.background='rgba(139, 92, 246, 0.1)'">
                            Edit
                        </button>
                        <button class="btn-delete" onclick="forceDelete('${product.id}')" style="background: rgba(239, 68, 68, 0.1); color: #ef4444; border: 1px solid rgba(239, 68, 68, 0.2); padding: 0.5rem 1rem; border-radius: 8px; cursor: pointer; transition: all 0.2s;" onmouseover="this.style.background='rgba(239, 68, 68, 0.2)'" onmouseout="this.style.background='rgba(239, 68, 68, 0.1)'">
                            Delete
                        </button>
                    </div>
                </div>
            `).join('');
        }

        // The Force Delete Function
        window.forceDelete = function (id) {
            console.log("Force Delete Key Pressed for ID: ", id);

            if (typeof products === 'undefined') {
                alert("System Error: Products not loaded.");
                return;
            }

            // Filter Global
            const startLen = products.length;
            products = products.filter(p => String(p.id) !== String(id));
            const endLen = products.length;

            // Save Global
            saveProducts();

            // Refresh UI
            if (startLen !== endLen) {
                renderAdminProductsDirect();
                // Removed Auto-popup. User must click "Sync" manually when done.
            } else {
                alert("Could not delete. ID mismatch?");
            }
        };

        // System Reset and Backup functions removed by user request for simplicity.
        // Data is autosaved to LocalStorage by script.js.

        // Add New Category - Show Modal
        window.addNewCategory = function () {
            const modal = document.getElementById('add-category-modal');
            const input = document.getElementById('new-category-input');
            modal.style.display = 'flex';
            input.value = '';
            setTimeout(() => input.focus(), 100);
        };

        // Close Modal
        window.closeAddCategoryModal = function () {
            document.getElementById('add-category-modal').style.display = 'none';
        };

        // Confirm Add Category
        window.confirmAddCategory = function () {
            const input = document.getElementById('new-category-input');
            const trimmedName = input.value.trim();

            if (!trimmedName) {
                alert("Please enter a category name!");
                return;
            }

            const categorySelect = document.getElementById('new-category');

            // Check if category already exists
            const existingOptions = Array.from(categorySelect.options).map(opt => opt.value);
            if (existingOptions.includes(trimmedName)) {
                alert("This category already exists!");
                return;
            }

            // Add new option to dropdown
            const newOption = document.createElement('option');
            newOption.value = trimmedName;
            newOption.textContent = trimmedName;
            categorySelect.appendChild(newOption);

            // Select the new category
            categorySelect.value = trimmedName;

            // Save categories to localStorage
            let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
            if (!customCategories.includes(trimmedName)) {
                customCategories.push(trimmedName);
                localStorage.setItem('customCategories', JSON.stringify(customCategories));
            }

            closeAddCategoryModal();
            alert(`Category "${trimmedName}" added successfully! âœ¨`);
        };

        // Remove Category
        window.removeCategory = function () {
            const categorySelect = document.getElementById('new-category');
            const selectedValue = categorySelect.value;

            // Prevent removing default categories
            const defaultCategories = ['Anime'];
            if (defaultCategories.includes(selectedValue)) {
                alert("Cannot remove default categories!");
                return;
            }

            // Remove from localStorage
            let customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
            customCategories = customCategories.filter(cat => cat !== selectedValue);
            localStorage.setItem('customCategories', JSON.stringify(customCategories));

            // Reload page to refresh everything
            alert(`Category "${selectedValue}" removed!`);
            location.reload();
        };

        // Load custom categories on page load
        function loadCustomCategories() {
            const customCategories = JSON.parse(localStorage.getItem('customCategories')) || [];
            const categorySelect = document.getElementById('new-category');

            customCategories.forEach(catName => {
                const newOption = document.createElement('option');
                newOption.value = catName;
                newOption.textContent = catName;
                categorySelect.appendChild(newOption);
            });
        }

        // Color Management Functions
        let selectedColors = [];

        window.toggleColor = function (colorHex, colorName) {
            const colorIndex = selectedColors.findIndex(c => c.hex === colorHex);
            const colorOption = document.querySelector(`.color-option[data-color="${colorHex}"]`);
            const checkmark = colorOption.querySelector('.color-check');
            const colorBox = colorOption.querySelector('div:first-child');

            if (colorIndex === -1) {
                // Add color
                selectedColors.push({ hex: colorHex, name: colorName });
                checkmark.style.opacity = '1';
                colorBox.style.transform = 'scale(0.9)';
                colorBox.style.borderColor = 'var(--accent-primary)';
                colorBox.style.boxShadow = '0 0 20px rgba(139, 92, 246, 0.5)';
            } else {
                // Remove color
                selectedColors.splice(colorIndex, 1);
                checkmark.style.opacity = '0';
                colorBox.style.transform = 'scale(1)';
                colorBox.style.borderColor = 'rgba(255,255,255,0.2)';
                colorBox.style.boxShadow = 'none';
            }

            updateSelectedColorsDisplay();
        };

        window.addCustomColor = function () {
            const colorPicker = document.getElementById('custom-color-picker');
            const colorNameInput = document.getElementById('custom-color-name');
            const colorHex = colorPicker.value.toUpperCase();
            const colorName = colorNameInput.value.trim() || 'Custom';

            // Check if color already exists
            if (selectedColors.some(c => c.hex === colorHex)) {
                alert('This color is already selected!');
                return;
            }

            // Add custom color
            selectedColors.push({ hex: colorHex, name: colorName });

            // Clear inputs
            colorNameInput.value = '';
            colorPicker.value = '#000000';

            updateSelectedColorsDisplay();

            // Show success feedback
            const btn = event.target;
            const originalText = btn.innerHTML;
            btn.innerHTML = 'âœ“ Added';
            btn.style.background = 'rgba(34, 197, 94, 0.2)';
            btn.style.borderColor = 'rgba(34, 197, 94, 0.4)';
            btn.style.color = '#22c55e';

            setTimeout(() => {
                btn.innerHTML = originalText;
                btn.style.background = 'rgba(139, 92, 246, 0.2)';
                btn.style.borderColor = 'rgba(139, 92, 246, 0.4)';
                btn.style.color = 'var(--accent-secondary)';
            }, 1500);
        };

        function updateSelectedColorsDisplay() {
            const display = document.getElementById('selected-colors-display');
            const list = document.getElementById('selected-colors-list');
            const hiddenInput = document.getElementById('product-colors');

            if (selectedColors.length === 0) {
                display.style.display = 'none';
                hiddenInput.value = '[]';
                return;
            }

            display.style.display = 'block';
            list.innerHTML = selectedColors.map((color, index) => `
                <div style="display: inline-flex; align-items: center; gap: 0.5rem; padding: 0.5rem 0.8rem; background: rgba(255,255,255,0.05); border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; transition: all 0.2s;">
                    <div style="width: 24px; height: 24px; background: ${color.hex}; border-radius: 6px; border: 1px solid rgba(255,255,255,0.2);"></div>
                    <span style="font-size: 0.85rem; color: white; font-weight: 500;">${color.name}</span>
                    <button type="button" onclick="removeSelectedColor(${index})" 
                        style="background: none; border: none; color: #ef4444; cursor: pointer; font-size: 1.2rem; line-height: 1; padding: 0; margin-left: 0.3rem; transition: transform 0.2s;"
                        onmouseover="this.style.transform='scale(1.2)'"
                        onmouseout="this.style.transform='scale(1)'">Ã—</button>
                </div>
            `).join('');

            // Update hidden input
            hiddenInput.value = JSON.stringify(selectedColors);
        }

        // ðŸ”„ AUTO-SYNC SYSTEM
        // We cache the handle so we can auto-save without asking.
        let cachedFileHandle = null;

        // Call this ONCE to link the file.
        window.initializeSync = async function () {
            try {
                const opts = {
                    types: [{
                        description: 'Product Database',
                        accept: { 'application/json': ['.json'] },
                    }],
                    suggestedName: 'product_data.json',
                };
                cachedFileHandle = await window.showSaveFilePicker(opts);

                // Visual Indicator that we are "Online"
                const indicator = document.getElementById('sync-status');
                if (indicator) {
                    indicator.innerText = "âš¡ Auto-Sync Active";
                    indicator.style.color = "#22c55e";
                    indicator.style.borderColor = "#22c55e";
                }

                // Immediate Save to prove it works
                await saveDatabaseToDisk();
            } catch (err) {
                console.log("Sync Init Cancelled");
            }
        };

        // This runs automatically whenever you Add/Edit/Delete
        window.saveDatabaseToDisk = async function () {
            // If we don't have permission yet, we can't auto-save silently.
            // We just return and wait for the user to click "Link Database" once.
            if (!cachedFileHandle) return;

            try {
                const data = JSON.stringify(window.products, null, 2);
                const writable = await cachedFileHandle.createWritable();
                await writable.write(data);
                await writable.close();
                console.log("âš¡ Auto-Saved to Disk");

                // Show a small toast notification
                const toast = document.createElement('div');
                toast.innerText = "â˜ï¸ Synced to Phones";
                toast.style.cssText = "position: fixed; bottom: 20px; right: 20px; background: #059669; color: white; padding: 10px 20px; border-radius: 50px; z-index: 9999; animation: fadeOut 3s forwards;";
                document.body.appendChild(toast);
                setTimeout(() => toast.remove(), 3000);
            } catch (err) {
                console.error("Auto-save failed:", err);
            }
        };

        // AUTO-SAVE TRIGGERS
        // We inject the saver into the existing functions
        const originalAdd = window.handleAddNewProduct;
        window.handleAddNewProduct = async function (event) {
            await originalAdd(event); // Run normal add logic
            await saveDatabaseToDisk(); // Then auto-save
        };

        const originalDelete = window.forceDelete;
        window.forceDelete = function (id) {
            originalDelete(id); // Run normal delete
            saveDatabaseToDisk(); // Then auto-save
        };

        // Run on load
        document.addEventListener('DOMContentLoaded', function () {
            loadCustomCategories();
            renderAdminProductsDirect();
        });
    </script>
</body>

</html>